<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>./src/index.js annotated source</title>
    <link rel="stylesheet" href="/animated-value/main.css">
</head>

<body>
    <main>
        <div class="line">
            <div class="doc">
                <h1>./src/index.js <span class="fade">annotated source</span></h1>
                <em><a class="back" href="/animated-value/">Back to index</a></em>
            </div>
            <pre></pre>
        </div>
        <div class="line"><div class="doc"><p>Animation curves are usually defined as cubic Bezier curves, but it turns out computing these functions on the fly from the time domain is pretty tricky. We depend on this ~500B library to resolve Bezier curves for us.</p>
</div><pre class="source javascript"><strong class="lineNumber">5</strong>import * as Bezier from 'bezier-easing';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">6</strong></pre></div>
<div class="line"><div class="doc"><p>Spring physics-based easing functions comes from this external dependency that resolves spring physics curves into functions.</p>
</div><pre class="source javascript"><strong class="lineNumber">9</strong>import {springFactory} from './spring.js';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">10</strong></pre></div>
<div class="line"><div class="doc"><p>Linear easing curve</p>
</div><pre class="source javascript"><strong class="lineNumber">12</strong>const identity = t =&#62; t;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">13</strong></pre></div>
<div class="line"><div class="doc"><p>Animation involves lots of measuring time. This is a shortcut to get the current unix epoch time in milliseconds.</p>
</div><pre class="source javascript"><strong class="lineNumber">17</strong>const now = () =&#62; Date.now();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">18</strong></pre></div>
<div class="line"><div class="doc"><p>AnimatedValue&#39;s animation objects are state machines, with three states. These three states are represented as these constants.</p>
</div><pre class="source javascript"><strong class="lineNumber">22</strong>const STATE_UNSTARTED = 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">23</strong>const STATE_PLAYING = 1;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">24</strong>const STATE_PAUSED = 2;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">25</strong></pre></div>
<div class="line"><div class="doc"><p>By default, <code>AnimatedValue.CURVES</code> provides a useful set of easing curves we can use out of the box.</p>
</div><pre class="source javascript"><strong class="lineNumber">28</strong>const CURVES = {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">29</strong>    LINEAR: identity,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">30</strong>    EASE: Bezier(0.25, 0.1, 0.25, 1),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">31</strong>    EASE_IN: Bezier(0.42, 0, 1, 1),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">32</strong>    EASE_OUT: Bezier(0, 0, 0.58, 1),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">33</strong>    EASE_IN_OUT: Bezier(0.42, 0, 0.58, 1),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">34</strong>    EASE_IN_BACK: Bezier(0.6, -0.28, 0.735, 0.045),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">35</strong>    EASE_OUT_BACK: Bezier(0.175, 0.885, 0.32, 1.275),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">36</strong>    EXPO_IN: Bezier(0.95, 0.05, 0.795, 0.035),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">37</strong>    EXPO_OUT: Bezier(0.19, 1, 0.22, 1),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">38</strong>    EXPO_IN_OUT: Bezier(1, 0, 0, 1),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">39</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">40</strong></pre></div>
<div class="line"><div class="doc"><h2 id="unified-frame-loop">Unified frame loop</h2>
</div><pre class="source javascript"><strong class="lineNumber">42</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>This section implements a unified frame loop for all animations performed by animated-value. Rather than each animated value orchestrating its own animation frame loop, if we implement one frame loop for the whole library and hook into it from each animated value, we can save many unnecessary calls to and from <code>requestAnimationFrame</code> during animation and keep code efficient.</p>
</div><pre class="source javascript"><strong class="lineNumber">48</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>Is the unified frame loop (UFL) currently running?</p>
</div><pre class="source javascript"><strong class="lineNumber">50</strong>let rafRunning = false;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>Queue of callbacks to be run on the next animation frame</p>
</div><pre class="source javascript"><strong class="lineNumber">52</strong>let rafQueue = [];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>The function that runs at most once every animation frame. This calls all queued callbacks once, and if necessary, enqueues a recursive call in the next frame.</p>
</div><pre class="source javascript"><strong class="lineNumber">56</strong>const runAnimationFrame = () =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">57</strong>    requestAnimationFrame(() =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">58</strong>        const q = rafQueue;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">59</strong>        rafQueue = [];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">60</strong>        for (const cb of q) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">61</strong>            cb();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">62</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">63</strong>        if (rafQueue.length &#62; 0) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">64</strong>            runAnimationFrame();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">65</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">66</strong>            rafRunning = false;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">67</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">68</strong>    });</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">69</strong>}</pre></div>
<div class="line"><div class="doc"><p>The animation frame callback that enqueues new callbacks into the next frame callback and optionally starts the frame loop if one is not running.</p>
</div><pre class="source javascript"><strong class="lineNumber">72</strong>const raf = callback =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">73</strong>    rafQueue.push(callback);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">74</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">75</strong>    if (!rafRunning) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">76</strong>        rafRunning = true;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">77</strong>        runAnimationFrame();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">78</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">79</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">80</strong></pre></div>
<div class="line"><div class="doc"><h2 id="playable-interface"><code>Playable</code> interface</h2>
</div><pre class="source javascript"><strong class="lineNumber">82</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>The <code>Playable</code> class represents something whose timeline can be played, paused, and reset. Both a single AnimatedValue, as well as <code>CompositeAnimatedValue</code> (a combination of more than one AV) inherit from <code>Playable</code>. This class enables us to have polymorphic, imperative animation control APIs.</p>
</div><pre class="source javascript"><strong class="lineNumber">88</strong>class Playable {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">89</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">90</strong>    constructor() {</pre></div>
<div class="line"><div class="doc"><p>A <code>Playable</code> is a state machine.</p>
</div><pre class="source javascript"><strong class="lineNumber">92</strong>        this.state = STATE_UNSTARTED;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>The duration requested for an animation play-through</p>
</div><pre class="source javascript"><strong class="lineNumber">94</strong>        this._duration = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>When did our current animation run start? <code>null</code> if the animation is not currently playing.</p>
</div><pre class="source javascript"><strong class="lineNumber">97</strong>        this._startTime = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>If we are paused, we keep track of how far through the animation we were here.</p>
</div><pre class="source javascript"><strong class="lineNumber">100</strong>        this._pausedTime = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>Callback after each frame is rendered during play</p>
</div><pre class="source javascript"><strong class="lineNumber">102</strong>        this._callback = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>A promise that resolves when the currently playing animation either finishes (resolves to <code>true</code>) or is reset (resolves to <code>false</code>).</p>
</div><pre class="source javascript"><strong class="lineNumber">105</strong>        this._promise = Promise.resolve();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>Temporary variable we use as a pointer to the resolver of <code>this._promise</code>, so we can resolve the promise outside of the promise body.</p>
</div><pre class="source javascript"><strong class="lineNumber">108</strong>        this._promiseResolver = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">109</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">110</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">111</strong>    play(duration, callback) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">112</strong>        if (this.state === STATE_PLAYING) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">113</strong>            return this._promise;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">114</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">115</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">116</strong>        this.state = STATE_PLAYING;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">117</strong>        this._duration = duration;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">118</strong>        this._startTime = now();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">119</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">120</strong>        this._promise = new Promise((res, _rej) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">121</strong>            this._promiseResolver = res;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">122</strong>            this._callback = () =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">123</strong>                if (callback !== undefined) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">124</strong>                    callback();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">125</strong>                }</pre></div>
<div class="line"><div class="doc"><p>Sometimes, in between frames, the user will pause the animation but we assume it isn&#39;t paused so we keep playing. This checks if we&#39;re supposed to still be playing the next frame.</p>
</div><pre class="source javascript"><strong class="lineNumber">130</strong>                if (this.state === STATE_PLAYING) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">131</strong>                    if (now() - this._startTime &#62; this._duration) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">132</strong>                        this.pause();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">133</strong>                        if (this._promiseResolver !== null) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">134</strong>                            this._promiseResolver(true);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">135</strong>                            this._promiseResolver = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">136</strong>                        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">137</strong>                    } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">138</strong>                        raf(this._callback);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">139</strong>                    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">140</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">141</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">142</strong>            this._callback();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">143</strong>        });</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">144</strong>        return this._promise;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">145</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">146</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">147</strong>    pause() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">148</strong>        if (this.state === STATE_PLAYING) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">149</strong>            this.state = STATE_PAUSED;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">150</strong>            this._pausedTime = now() - this._startTime;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">151</strong>            this._startTime = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">152</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">153</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">154</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">155</strong>    resume() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">156</strong>        if (this.state === STATE_PAUSED) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">157</strong>            this.state = STATE_PLAYING;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">158</strong>            this._startTime = now() - this._pausedTime;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">159</strong>            this._pausedTime = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">160</strong>            this._callback();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">161</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">162</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">163</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">164</strong>    reset() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">165</strong>        if (this._promiseResolver !== null) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">166</strong>            this._promiseResolver(false);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">167</strong>            this._promiseResolver = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">168</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">169</strong>        this.state = STATE_UNSTARTED;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">170</strong>        this._duration = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">171</strong>        this._startTime = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">172</strong>        this._pausedTime = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">173</strong>        this._callback = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">174</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">175</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">176</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">177</strong></pre></div>
<div class="line"><div class="doc"><p><code>AnimatedValue</code> represents a single value (number) that can be animated with a duration and an easing curve. Most often, an <code>AnimatedValue</code> corresponds to a single CSS property that we&#39;re animating on a component, like translate / scale / opacity.</p>
</div><pre class="source javascript"><strong class="lineNumber">182</strong>class AnimatedValue extends Playable {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">183</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">184</strong>    constructor({</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">185</strong>        start = 0,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">186</strong>        end = 1,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">187</strong>        ease = identity,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">188</strong>    } = {}) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">189</strong>        super();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">190</strong>        this.start = start;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">191</strong>        this.end = end;</pre></div>
<div class="line"><div class="doc"><p>We accept an array of cubic Bezier points as an easing function, in which case we create a Bezier curve out of them.</p>
</div><pre class="source javascript"><strong class="lineNumber">194</strong>        this.ease = Array.isArray(ease) ? Bezier(...ease) : ease;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>The fill state represents the value of the animated value whenever the animation is not running. The value is initialized to the start position.</p>
</div><pre class="source javascript"><strong class="lineNumber">197</strong>        this._fillState = start;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">198</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">199</strong></pre></div>
<div class="line"><div class="doc"><p>Statically defined so consumers of the API can define easing curves as <code>AnimatedValue.CURVES.[CURVE_NAME]</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">202</strong>    static get CURVES() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">203</strong>        return CURVES;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">204</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">205</strong></pre></div>
<div class="line"><div class="doc"><p>Statically defined constructor for a composite animation, which takes multiple <code>Playable</code>s (either single or composite animated values) and plays all of them concurrently.</p>
</div><pre class="source javascript"><strong class="lineNumber">209</strong>    static compose(...playables) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">210</strong>        return new CompositeAnimatedValue(playables);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">211</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">212</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">213</strong>    static get Kinetic() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">214</strong>        return KineticValue;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">215</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">216</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">217</strong>    set(value) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">218</strong>        this._fillState = value;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">219</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">220</strong></pre></div>
<div class="line"><div class="doc"><p>What&#39;s the current numerical value of this animated value? This API is intentionally not implemented as a getter, to communicate to the API consumer that value computation has a nonzero cost with each access.</p>
</div><pre class="source javascript"><strong class="lineNumber">224</strong>    value() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">225</strong>        if (this.state !== STATE_PLAYING) {</pre></div>
<div class="line"><div class="doc"><p>If the animation is not playing, just return the last fill value</p>
</div><pre class="source javascript"><strong class="lineNumber">227</strong>            return this._fillState;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">228</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">229</strong>            const elapsedTime = now() - this._startTime;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">230</strong>            const elapsedDuration = elapsedTime &#62; this._duration ? 1 : elapsedTime / this._duration;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">231</strong>            return ((this.end - this.start) * this.ease(elapsedDuration)) + this.start;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">232</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">233</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">234</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">235</strong>    pause() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">236</strong>        if (this.state === STATE_PLAYING) {</pre></div>
<div class="line"><div class="doc"><p>The order of <code>super</code> call matters here, because we can&#39;t get the value if we aren&#39;t playing</p>
</div><pre class="source javascript"><strong class="lineNumber">238</strong>            this._fillState = this.value();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">239</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">240</strong>        super.pause();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">241</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">242</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">243</strong>    reset() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">244</strong>        super.reset();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">245</strong>        this._fillState = this.start;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">246</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">247</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">248</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">249</strong></pre></div>
<div class="line"><div class="doc"><p>A <code>CompositeAnimatedValue</code> is a <code>Playable</code> wrapper around many (single, composite) animated values, that can run all of the animations in the same duration, concurrently. <code>CompositeAnimatedValue</code> is polymorphic, and can take any <code>Playable</code> as a sub-animation.</p>
</div><pre class="source javascript"><strong class="lineNumber">253</strong>class CompositeAnimatedValue extends Playable {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">254</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">255</strong>    constructor(playables) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">256</strong>        super();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">257</strong>        this._playables = playables;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">258</strong>        for (const p of this._playables) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">259</strong>            if (p instanceof KineticValue) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">260</strong>                console.warn('AnimatedValue.Kinetic cannot be composed into composite animated values. Doing so may result in buggy and undefined behavior.');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">261</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">262</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">263</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">264</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">265</strong>    play(duration, callback) {</pre></div>
<div class="line"><div class="doc"><p><code>CompositeAnimatedValue#play()</code> swallows the callback here and calls it once for the entire composition, efficiently, so the callback isn&#39;t called N times for N animated values below this composite animation.</p>
</div><pre class="source javascript"><strong class="lineNumber">269</strong>        const ret = super.play(duration, callback);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">270</strong>        for (const av of this._playables) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">271</strong>            av.play(duration);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">272</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">273</strong>        return ret;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">274</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">275</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">276</strong>    pause() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">277</strong>        super.pause();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">278</strong>        for (const av of this._playables) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">279</strong>            av.pause();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">280</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">281</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">282</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">283</strong>    resume() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">284</strong>        if (this.state === STATE_PAUSED) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">285</strong>            for (const av of this._playables) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">286</strong>                av.resume();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">287</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">288</strong>        }</pre></div>
<div class="line"><div class="doc"><p>Order of <code>super.resume()</code> call is important -- if we resume first, the checks above don&#39;t work</p>
</div><pre class="source javascript"><strong class="lineNumber">290</strong>        super.resume();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">291</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">292</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">293</strong>    reset() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">294</strong>        super.reset();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">295</strong>        for (const av of this._playables) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">296</strong>            av.reset();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">297</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">298</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">299</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">300</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">301</strong></pre></div>
<div class="line"><div class="doc"><p>A <code>KineticValue</code> or <code>AnimatedValue.Kinetic</code> is an animated value whose animations are defined by spring physics. As such, it takes only a starting position and some phsyics constants, and are aniamted to destination coordinates. Kinetic values also cannot be reset.</p>
</div><pre class="source javascript"><strong class="lineNumber">305</strong>class KineticValue extends AnimatedValue {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">306</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">307</strong>    constructor({</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">308</strong>        start = 0,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">309</strong>        end = null,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">310</strong>        stiffness = 3,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">311</strong>        damping = .8,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">312</strong>        duration = 1000,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">313</strong>    } = {}) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">314</strong>        if (end === null) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">315</strong>            end = start;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">316</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">317</strong>        stiffness = ~~stiffness;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">318</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">319</strong>        const ease = springFactory({</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">320</strong>            damping,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">321</strong>            stiffness,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">322</strong>            initial_velocity: 0,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">323</strong>        });</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">324</strong>        super({</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">325</strong>            start,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">326</strong>            end,</pre></div>
<div class="line"><div class="doc"><p>Functions from <code>springFactory</code> start at 1 and go to 0, so we need to invert it for our use case.</p>
</div><pre class="source javascript"><strong class="lineNumber">329</strong>            ease: t =&#62; 1 - ease(t),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">330</strong>        });</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">331</strong>        this.damping = damping;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">332</strong>        this.stiffness = stiffness;</pre></div>
<div class="line"><div class="doc"><p>In kinetic physics-based animations, the animation duration is a parameter over the whole spring, not a single animation. So we set it for the value itself and store it here to use it in every animation instance.</p>
</div><pre class="source javascript"><strong class="lineNumber">336</strong>        this._dynDuration = duration;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">337</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">338</strong></pre></div>
<div class="line"><div class="doc"><p><code>playTo()</code> substitutes <code>play()</code> for kinetic values, and is the way to animate the spring animated value to a new value.</p>
</div><pre class="source javascript"><strong class="lineNumber">341</strong>    playTo(end, callback) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">342</strong>        const n = now();</pre></div>
<div class="line"><div class="doc"><p>Get elapsed time scaled to the range [0, 1]</p>
</div><pre class="source javascript"><strong class="lineNumber">344</strong>        const elapsed = (n - this._startTime) / this._duration;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">345</strong></pre></div>
<div class="line"><div class="doc"><p>Determine instantaneous velocity</p>
</div><pre class="source javascript"><strong class="lineNumber">347</strong>        const DIFF = 0.0001;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">348</strong>        const velDiff = (this.ease(elapsed) - this.ease(elapsed - DIFF)) / DIFF;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">349</strong></pre></div>
<div class="line"><div class="doc"><p>Scale the velocity to the new start and end coordinates, since the distance covered will modify how the [0, 1] range scales out to real values.</p>
</div><pre class="source javascript"><strong class="lineNumber">352</strong>        const scaledVel = velDiff * (this.end - this.start) / (end - this.value());</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">353</strong></pre></div>
<div class="line"><div class="doc"><p>Create a new easing curve based on the new velocity</p>
</div><pre class="source javascript"><strong class="lineNumber">355</strong>        const ease = springFactory({</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">356</strong>            damping: this.damping,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">357</strong>            stiffness: this.stiffness,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">358</strong>            initial_velocity: -scaledVel,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">359</strong>        });</pre></div>
<div class="line"><div class="doc"><p>Reset animation values so the next frame will render  using the new animation parameters</p>
</div><pre class="source javascript"><strong class="lineNumber">361</strong>        this.start = this.value();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">362</strong>        this.end = end;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">363</strong>        this.ease = t =&#62; 1 - ease(t);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">364</strong>        this._startTime = n;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">365</strong></pre></div>
<div class="line"><div class="doc"><p>If there is not already an animation running, start it.</p>
</div><pre class="source javascript"><strong class="lineNumber">367</strong>        if (this.state !== STATE_PLAYING) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">368</strong>            super.play(this._dynDuration, callback);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">369</strong>        }</pre></div>
<div class="line"><div class="doc"><p>Return promise for chaining calls.</p>
</div><pre class="source javascript"><strong class="lineNumber">371</strong>        return this._promise;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">372</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">373</strong></pre></div>
<div class="line"><div class="doc"><p>Warnings for APIs that do not apply to kinetic values</p>
</div><pre class="source javascript"><strong class="lineNumber">375</strong>    play() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">376</strong>        console.warn('Kinetic Animated Values should be played with playTo()');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">377</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">378</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">379</strong>    reset() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">380</strong>        console.warn('Kinetic Animated Values cannot be reset');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">381</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">382</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">383</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">384</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">385</strong>if (typeof window === 'object') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">386</strong>    window.AnimatedValue = AnimatedValue;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">387</strong>} else if (module &#38;&#38; module.exports) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">388</strong>    module.exports = {AnimatedValue};</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">389</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">390</strong></pre></div>
    </main>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/github-gist.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>
        for (const el of document.querySelectorAll('.line pre')) {
            hljs.highlightBlock(el);
        }
    </script>
</body>

</html>